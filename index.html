<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ—¥èªå°æ•™å®¤</title>
  <style>
    body {
      font-family: system-ui, "Noto Sans CJK", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 24px;
      color: #111;
    }
    .container { max-width: 900px; margin: 0 auto; }
    
    h1 { 
      margin: 0 0 24px 0; 
      font-size: 2rem; 
      color: #fff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      text-align: center;
    }

    .card {
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      margin-top: 20px;
      transition: 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 16px 50px rgba(0,0,0,0.2);
    }

    h2 {
      color: #667eea;
      font-size: 1.4rem;
      margin-top: 0;
      margin-bottom: 16px;
      border-left: 4px solid #667eea;
      padding-left: 12px;
    }

    .video-wrap { 
      width:100%; 
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
    }
    .video-wrap video { 
      width:100%; 
      display: block;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    button:hover:not([disabled]) { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    button:active:not([disabled]) {
      transform: translateY(0);
    }
    button[disabled] { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }

    .hidden { display:none; }

    .quiz-area {
      background: linear-gradient(135deg, #f5f7ff 0%, #e8ecff 100%);
      border: 2px solid #667eea;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    .quiz-area h3 {
      color: #667eea;
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .quiz-area .answer-input {
      width: 60%;
      max-width: 420px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 2px solid #dde3ff;
      font-size: 14px;
      margin-bottom: 12px;
      transition: all 0.2s;
      background: #fff;
      display: block;
    }
    .quiz-area input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* å–®é¡Œç­”éŒ¯æ™‚æŠŠè©²é¡Œæ¨™æˆç´…è‰² */
    .question-block.wrong .kana-box {
      background: linear-gradient(135deg,#ff6b6b 0%, #ff9a9a 100%);
      color: #fff;
    }
    .question-block.wrong .answer-input {
      border-color: #ff6b6b;
      box-shadow: 0 4px 12px rgba(255,107,107,0.12);
    }

    .mc-block {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 2px solid #e8ecff;
      transition: all 0.2s;
    }
    .mc-block:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .mc-block p {
      margin: 0 0 12px 0;
      font-weight: 600;
      color: #333;
    }

    .mc-block label {
      display: block;
      margin: 8px 0;
      padding: 10px 12px;
      border-radius: 8px;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.2s;
      color: #555;
    }
    .mc-block label:hover {
      background: #e8ecff;
      color: #667eea;
    }

    .mc-block input[type="radio"] {
      margin-right: 8px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .kana-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 12px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    /* å¤±æ•—æ™‚ç´…è‰²ä¸¦æ–å‹• */
    .quiz-area.danger {
      background: linear-gradient(135deg, #ffe8e8 0%, #ffd4d4 100%);
      border-color: #ff6b6b;
      box-shadow: 0 8px 24px rgba(255, 107, 107, 0.2);
    }

    @keyframes shake { 
      0%,100%{transform:translateX(0);} 
      20%{transform:translateX(-12px);} 
      40%{transform:translateX(12px);} 
      60%{transform:translateX(-8px);} 
      80%{transform:translateX(8px);} 
    }
    .shake-card { animation: shake 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97); }

    /* äº”åéŸ³è¡¨æ ¼ */
    .kana-panel {
      margin-top: 16px;
      border-radius: 14px;
      background: #fff;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.1);
      max-height: 360px;
      overflow-y: auto;
      transition: all 0.2s;
      border: 2px solid #e8ecff;
    }

    .kana-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }
    .kana-table td {
      border: 1px solid #e8ecff;
      padding: 10px;
      text-align: center;
      vertical-align: middle;
      min-width: 64px;
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      transition: all 0.2s;
    }
    .kana-table td:hover {
      background: linear-gradient(135deg, #f5f7ff 0%, #e8ecff 100%);
    }

    .kana-cell-kana { 
      font-size: 24px; 
      font-weight: 700; 
      color: #667eea;
    }
    .kana-cell-rom { 
      font-size: 11px; 
      color: #888; 
      margin-top: 4px; 
    }

    .kana-panel .note { 
      font-size: 12px; 
      color: #666; 
      margin-bottom: 12px;
      font-weight: 500;
    }

    .controls-row { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      margin-top: 16px; 
      flex-wrap: wrap; 
    }

    #score-50, #score-intro, #score-phrases {
      margin-top: 16px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-left: 4px solid #4caf50;
      border-radius: 8px;
      color: #2e7d32;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .info-text {
      font-size: 13px;
      color: #999;
    }

    /* æ»‘é¼ é»æ“Šç‰¹æ•ˆ */
    .click-effect {
      position: fixed;
      pointer-events: none;
      font-size: 24px;
      font-weight: 700;
      z-index: 9999;
      animation: popFloat 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    @keyframes popFloat {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(0, -80px) scale(1.5);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ“š æ—¥èªå°æ•™å®¤</h1>

  <section class="card" id="stage-1">
    <h2>éšæ®µ 1ï¼šäº”åéŸ³å­¸ç¿’</h2>
    <div class="video-wrap">
      <video id="video-50" controls preload="none" src="äº”åéŸ³.mp4"></video>
    </div>

    <div class="controls-row">
      <button id="btn-start-quiz-50">ğŸ¯ é–‹å§‹äº”åéŸ³æ¸¬é©—</button>
      <button id="btn-toggle-table-50" type="button" aria-expanded="false">ğŸ“‹ æŸ¥çœ‹äº”åéŸ³è¡¨</button>
      <div style="flex:1"></div>
      <span class="info-text">â€» æ¸¬é©—é–‹å§‹å¾Œå°‡é–å®šè¡¨æ ¼ç›´åˆ°ç¹³äº¤</span>
    </div>

    <div id="kana-panel" class="kana-panel hidden" aria-hidden="true">
      <div class="note">âœ¨ äº”åéŸ³è¡¨ï¼ˆé»æ“Šã€ŒæŸ¥çœ‹äº”åéŸ³è¡¨ã€å¯é—œé–‰ï¼é–‹å•Ÿï¼‰</div>
      <div id="kana-table-wrap"></div>
    </div>

    <div id="quiz-50" class="quiz-area hidden">
      <h3>ğŸ”¤ è«‹å¡«å¯«ç¾…é¦¬æ‹¼éŸ³ï¼ˆå…± 5 é¡Œï¼‰</h3>
      <div id="quiz-50-questions"></div>
      <button id="submit-50" style="margin-top: 16px;">âœ… äº¤å·</button>
      <div id="score-50"></div>
    </div>
  </section>

  <section class="card" id="stage-2">
    <h2>éšæ®µ 2ï¼šè‡ªæˆ‘ä»‹ç´¹æ•™å­¸</h2>
    <div class="video-wrap">
      <video id="video-intro" controls preload="none" src="æ—¥æ–‡è‡ªæˆ‘ä»‹ç´¹.mp4"></video>
    </div>
    <button id="btn-start-quiz-intro" disabled>ğŸ¤ é–‹å§‹è‡ªæˆ‘ä»‹ç´¹æ¸¬é©—</button>

    <div id="quiz-intro" class="quiz-area hidden">
      <h3>ğŸ“ é¸æ“‡é¡Œï¼ˆ3 é¡Œï¼‰</h3>
      <div id="quiz-intro-questions"></div>
      <button id="submit-intro" style="margin-top: 16px;">âœ… äº¤å·</button>
      <div id="score-intro"></div>
    </div>
  </section>

  <section class="card" id="stage-3">
    <h2>éšæ®µ 3ï¼šæ—¥å¸¸ç”¨èª</h2>
    <div class="video-wrap">
      <video id="video-phrases" controls preload="none" src="æ—¥å¸¸ç”¨èª.mp4"></video>
    </div>
    <button id="btn-start-quiz-phrases" disabled>ğŸ“ é–‹å§‹æ—¥å¸¸ç”¨èªå°æ¸¬é©—</button>

    <div id="quiz-phrases" class="quiz-area hidden">
      <h3>ğŸ’¬ æ—¥å¸¸ç”¨èª - é¸æ“‡é¡Œï¼ˆéš¨æ©Ÿ 5 é¡Œï¼‰</h3>
      <div id="quiz-phrases-questions"></div>
      <button id="submit-phrases" style="margin-top: 16px;">âœ… äº¤å·</button>
      <div id="score-phrases"></div>
    </div>
  </section>

  <!-- æ–°å¢ï¼šç¸½æˆç¸¾å€å¡Šï¼ˆæœƒåœ¨ä¸‰å€‹æ¸¬é©—éƒ½äº¤å·å¾Œé¡¯ç¤ºï¼‰ -->
  <section id="overall-summary" class="card hidden">
    <h2>ğŸ† ç¸½æˆç¸¾</h2>
    <div id="overall-score" style="font-size:16px; font-weight:700; color:#2e7d32;"></div>
  </section>
</div>

<script>
const PASS_RATE = 0.8;
// ç´€éŒ„å„æ¸¬é©—æˆç¸¾ç‹€æ…‹
let scoreState = {
  quiz50: null,    // { correct, total }
  intro: null,     // { correct, total }
  phrases: null    // { correct, total }
};

function updateOverallDisplay(){
  if(!scoreState.quiz50 || !scoreState.intro || !scoreState.phrases) return;
  const totCorrect = scoreState.quiz50.correct + scoreState.intro.correct + scoreState.phrases.correct;
  const totPossible = scoreState.quiz50.total + scoreState.intro.total + scoreState.phrases.total;
  const percent = Math.round((totCorrect / totPossible) * 100);
  $('overall-score').innerHTML = `ç¸½å¾—åˆ†ï¼š${percent}%ï¼ˆ${totCorrect}/${totPossible}ï¼‰`;
  $('overall-summary').classList.remove('hidden');
}
 
const kanaList = [
 ['ã‚','a'],['ã„','i'],['ã†','u'],['ãˆ','e'],['ãŠ','o'],
 ['ã‹','ka'],['ã','ki'],['ã','ku'],['ã‘','ke'],['ã“','ko'],
 ['ã•','sa'],['ã—','shi'],['ã™','su'],['ã›','se'],['ã','so'],
 ['ãŸ','ta'],['ã¡','chi'],['ã¤','tsu'],['ã¦','te'],['ã¨','to'],
 ['ãª','na'],['ã«','ni'],['ã¬','nu'],['ã­','ne'],['ã®','no'],
 ['ã¯','ha'],['ã²','hi'],['ãµ','fu'],['ã¸','he'],['ã»','ho'],
 ['ã¾','ma'],['ã¿','mi'],['ã‚€','mu'],['ã‚','me'],['ã‚‚','mo'],
 ['ã‚„','ya'],['ã‚†','yu'],['ã‚ˆ','yo'],
 ['ã‚‰','ra'],['ã‚Š','ri'],['ã‚‹','ru'],['ã‚Œ','re'],['ã‚','ro'],
 ['ã‚','wa'],['ã‚’','wo'],['ã‚“','n']
];

const introQuestions = [
  {q:'ã€Œã¯ã˜ã‚ã¾ã—ã¦ã€çš„æ„æ€æ˜¯ï¼Ÿ', c:['å†è¦‹','åˆæ¬¡è¦‹é¢','è¬è¬'], a:1},
  {q:'ã€Œã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€ä»£è¡¨ï¼Ÿ', c:['è«‹å¤šæŒ‡æ•™','æˆ‘è‚šå­é¤“','æˆ‘åœ¨å”±æ­Œ'], a:0},
  {q:'é‡åˆ°ç¬¬ä¸€æ¬¡è¦‹é¢çš„äººï¼Œå¸¸è¦‹é †åºæ˜¯ï¼Ÿ', c:['å§“åâ†’èº«åˆ†â†’çµå°¾å•å€™','æ˜Ÿåº§â†’è¡€å‹â†’èˆˆè¶£','å¹´é½¡â†’èº«é«˜â†’é«”é‡'], a:0},
];

const phraseList = [
  ['ã“ã‚“ã«ã¡ã¯','ä½ å¥½'],
  ['ãŠã¯ã‚ˆã†ï¼ˆã”ã–ã„ã¾ã™ï¼‰','æ—©å®‰'],
  ['ã“ã‚“ã°ã‚“ã¯','æ™šä¸Šå¥½'],
  ['ãŠã‚„ã™ã¿ï¼ˆãªã•ã„ï¼‰','æ™šå®‰'],
  ['ã•ã‚ˆã†ãªã‚‰','å†è¦‹'],
  ['ã˜ã‚ƒã€ã¾ãŸï¼ˆã‚ã„ã¾ã—ã‚‡ã†ï¼‰','å†è¦‹'],
  ['ã‚ã‚ŠãŒã¨ã†ï¼ˆã”ã–ã„ã¾ã™ï¼‰','è¬è¬'],
  ['ã©ã†ã„ãŸã—ã¾ã—ã¦','ä¸å®¢æ°£'],
  ['ã™ã¿ã¾ã›ã‚“','å°ä¸èµ·ï¼ä¸å¥½æ„æ€'],
  ['ã‚ˆã‚ã—ãï¼ˆãŠã­ãŒã„ã—ã¾ã™ï¼‰','è«‹å¤šæŒ‡æ•™'],
  ['ãŠã­ãŒã„ã—ã¾ã™','éº»ç…©æ‚¨'],
  ['ï¼ˆãŠï¼‰ã²ã•ã—ã¶ã‚Šï¼ˆã§ã™ï¼‰','å¥½ä¹…ä¸è¦‹'],
  ['ï¼ˆãŠï¼‰ã’ã‚“ãï¼ˆã§ã™ã‹ï¼‰ï¼Ÿ','ä½ å¥½å—ï¼Ÿ'],
  ['ãŠã‚ã§ã¨ã†ï¼ˆã”ã–ã„ã¾ã™ï¼‰','æ­å–œæ‚¨'],
  ['ãŠã ã„ã˜ã«','è«‹ä¿é‡'],
  ['ãŠã¤ã‹ã‚Œã•ã¾ã§ã™','è¾›è‹¦äº†'],
  ['ã„ãŸã ãã¾ã™','é–‹å‹•ï¼ˆæ„Ÿè¬ï¼‰'],
  ['ã”ã¡ãã†ã•ã¾ã§ã—ãŸ','åƒé£½äº†ï¼ˆæ„Ÿè¬ï¼‰'],
  ['ã„ã£ã¦ãã¾ã™','æˆ‘è¦å‡ºé–€äº†'],
  ['ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„','æ…¢èµ°'],
  ['ãŸã ã„ã¾','æˆ‘å›ä¾†äº†'],
  ['ãŠã‹ãˆã‚Šï¼ˆãªã•ã„ï¼‰','ä½ å›ä¾†äº†'],
  ['ã¯ã˜ã‚ã¾ã—ã¦','åˆæ¬¡è¦‹é¢'],
  ['ã¡ã‚‡ã£ã¨ã¾ã£ã¦ï¼ˆãã ã•ã„ï¼‰','è«‹ç­‰ä¸€ä¸‹ã€‚']
];

const clickEmojis = ['âœ¨', 'ğŸ‰', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'ğŸ’¥', 'ğŸŠ', 'ğŸŒˆ', 'ğŸ”¥', 'ğŸ’'];

function $(id){return document.getElementById(id)}
function shuffle(arr){return arr.sort(()=>Math.random()-0.5)}

/* æ–°å¢ï¼šæ»‘é¼ é»æ“Šç‰¹æ•ˆ */
document.addEventListener('click', (e) => {
  const effect = document.createElement('div');
  effect.className = 'click-effect';
  effect.textContent = clickEmojis[Math.floor(Math.random() * clickEmojis.length)];
  effect.style.left = e.clientX + 'px';
  effect.style.top = e.clientY + 'px';
  effect.style.color = ['#FF6B9D', '#FFA502', '#26C485', '#5E72E4', '#FF5733'][Math.floor(Math.random() * 5)];
  document.body.appendChild(effect);
  
  setTimeout(() => effect.remove(), 800);
});

let kanaTableLocked = false;
const btnToggleTable = $('btn-toggle-table-50');
const kanaPanel = $('kana-panel');
const kanaTableWrap = $('kana-table-wrap');

function renderKanaTable(){
  const perRow = 5;
  const table = document.createElement('table');
  table.className = 'kana-table';
  let row;
  kanaList.forEach((k, idx) => {
    if(idx % perRow === 0){
      row = document.createElement('tr');
      table.appendChild(row);
    }
    const td = document.createElement('td');
    td.innerHTML = `<div class="kana-cell-kana">${k[0]}</div><div class="kana-cell-rom">${k[1]}</div>`;
    row.appendChild(td);
  });
  const lastCells = row ? row.children.length : 0;
  if(lastCells > 0 && lastCells < perRow){
    for(let i=0;i<perRow-lastCells;i++){
      const td = document.createElement('td');
      td.innerHTML = '&nbsp;';
      row.appendChild(td);
    }
  }
  kanaTableWrap.innerHTML = '';
  kanaTableWrap.appendChild(table);
}
renderKanaTable();

btnToggleTable.addEventListener('click', () => {
  if(kanaTableLocked) return;
  const isHidden = kanaPanel.classList.contains('hidden');
  if(isHidden){
    kanaPanel.classList.remove('hidden');
    btnToggleTable.setAttribute('aria-expanded','true');
    kanaPanel.setAttribute('aria-hidden','false');
  } else {
    kanaPanel.classList.add('hidden');
    btnToggleTable.setAttribute('aria-expanded','false');
    kanaPanel.setAttribute('aria-hidden','true');
  }
});

$('btn-start-quiz-50').onclick = () => {
  kanaPanel.classList.add('hidden');
  btnToggleTable.setAttribute('aria-expanded','false');
  kanaTableLocked = true;
  btnToggleTable.disabled = true;

  const area = $('quiz-50');
  const qBox = $('quiz-50-questions');
  area.classList.remove('hidden');

  qBox.innerHTML = '';
  let qs = shuffle([...kanaList]).slice(0,5);

  qs.forEach(k => {
    let div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `<div class='kana-box'>${k[0]}</div>
                     <input type="text" class="answer-input" data-answer='${k[1]}' placeholder='è¼¸å…¥ç¾…é¦¬æ‹¼éŸ³'>`;
    qBox.appendChild(div);
  });
};

$('submit-50').onclick = () => {
  const inputs = [...document.querySelectorAll('#quiz-50-questions input.answer-input')];
  let correct = 0;
  inputs.forEach(inp => {
    const ok = inp.value.trim().toLowerCase() === inp.dataset.answer;
    const container = inp.closest('.question-block');
    if(ok){
      correct++;
      if(container) container.classList.remove('wrong');
    } else {
      if(container) container.classList.add('wrong');
    }
  });
  let score = correct / inputs.length;
  const percent = Math.round(score * 100);
  $('score-50').innerHTML = `ğŸ‰ å¾—åˆ†ï¼š${percent}% (${correct}/${inputs.length})${score >= PASS_RATE ? ' âœ¨ å„ªç§€ï¼' : ''}`;

  // è¨˜éŒ„ä¸¦æ›´æ–°ç¸½æˆç¸¾é¡¯ç¤º
  scoreState.quiz50 = { correct: correct, total: inputs.length };
  updateOverallDisplay();

  if(score >= PASS_RATE){
    $('btn-start-quiz-intro').disabled = false;
  } else {
    crowFly();
  }

  kanaTableLocked = false;
  btnToggleTable.disabled = false;

  sendScoreToMoodle(percent);
};

function sendScoreToMoodle(percent){
  fetch('/moodle/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ score_percent: percent })
  }).catch(()=> {
    // å¿½ç•¥éŒ¯èª¤
  });
}

$('btn-start-quiz-intro').onclick = () => {
  $('quiz-intro').classList.remove('hidden');
  const box = $('quiz-intro-questions');
  box.innerHTML = '';

  introQuestions.forEach((q,i) => {
    let div = document.createElement('div');
    div.className='mc-block';
    div.innerHTML = `<p>${q.q}</p>` +
      q.c.map((c,idx)=>`<label><input type='radio' name='intro${i}' value='${idx}'> ${c}</label>`).join('');
    box.appendChild(div);
  });
};

$('submit-intro').onclick = () => {
  let correct = 0;
  introQuestions.forEach((q,i)=>{
    let choice = document.querySelector(`input[name=intro${i}]:checked`);
    if(choice && Number(choice.value)===q.a) correct++;
  });

  $('score-intro').innerHTML = `ğŸ‰ å¾—åˆ†ï¼š${correct}/${introQuestions.length}${correct / introQuestions.length >= PASS_RATE ? ' âœ¨ å„ªç§€ï¼' : ''}`;
  // è¨˜éŒ„ä¸¦æ›´æ–°ç¸½æˆç¸¾é¡¯ç¤º
  scoreState.intro = { correct: correct, total: introQuestions.length };
  updateOverallDisplay();

  // ä¸è¨­é–€æª»ï¼šç„¡è«–å¾—åˆ†å¦‚ä½•éƒ½å¯ä»¥é–‹å§‹æœ€å¾Œä¸€å€‹å•å·
  $('btn-start-quiz-phrases').disabled = false;
};

$('btn-start-quiz-phrases').onclick = () => {
  $('quiz-phrases').classList.remove('hidden');
  const box = $('quiz-phrases-questions');
  box.innerHTML = '';

  const questions = shuffle([...phraseList]).slice(0,5);

  questions.forEach((item, qi) => {
    const [jp, zh] = item;
    const others = shuffle(phraseList.filter(p => p[0] !== jp)).slice(0,3).map(p => p[1]);
    const opts = shuffle([zh, ...others]);

    const div = document.createElement('div');
    div.className = 'mc-block';
    let html = `<p>${qi+1}. ${jp} çš„æ„æ€æ˜¯ï¼Ÿ</p>`;
    html += opts.map((o, idx) => `<label><input type="radio" name="phr${qi}" value="${o}"> ${o}</label>`).join('');
    div.dataset.correct = zh;
    div.innerHTML = html;
    box.appendChild(div);
  });
};

$('submit-phrases').onclick = () => {
  const blocks = [...document.querySelectorAll('#quiz-phrases-questions .mc-block')];
  let correct = 0;
  blocks.forEach((blk, i) => {
    const sel = blk.querySelector('input[type=radio]:checked');
    const ok = sel && sel.value === blk.dataset.correct;
    if(ok){
      correct++;
      blk.classList.remove('wrong');
    } else {
      blk.classList.add('wrong');
    }
  });
  $('score-phrases').innerHTML = `ğŸ‰ å¾—åˆ†ï¼š${correct}/${blocks.length}${correct / blocks.length >= PASS_RATE ? ' âœ¨ å„ªç§€ï¼' : ''}`;
  // è¨˜éŒ„ä¸¦æ›´æ–°ç¸½æˆç¸¾é¡¯ç¤º
  scoreState.phrases = { correct: correct, total: blocks.length };
  updateOverallDisplay();
  if(correct / blocks.length < PASS_RATE) crowFly();
};

function crowFly(){
  const visibleQuizzes = [...document.querySelectorAll('.quiz-area')].filter(el => !el.classList.contains('hidden'));
  if(visibleQuizzes.length === 0){
    const card = document.querySelector('.card');
    applyDanger(card);
  } else {
    visibleQuizzes.forEach(q => applyDanger(q));
  }

  function applyDanger(el){
    if(!el) return;
    el.classList.add('danger','shake-card');
    setTimeout(()=> el.classList.remove('shake-card'), 700);
    setTimeout(()=> el.classList.remove('danger'), 1400);
  }
}
</script>
</body>
</html>